name: build

on:
  push:
  pull_request:
  workflow_dispatch:
  schedule:
    # Temporary frequent schedule to repro some onebox issues.
    - cron: '0 */6 * * *'  # Runs every 6 hours

env:
  # Define the minimum Rust version to test
  RUST_MIN_VERSION: '1.90.0'

jobs:
  # The 'env' context is not available in strategy/matrix definitions.
  # This setup job acts as a bridge to convert the env var into a job output,
  # which can then be consumed by other jobs via the 'needs' context.
  setup:
    runs-on: ubuntu-latest
    outputs:
      rust-versions: ${{ steps.set-versions.outputs.rust-versions }}
      rust-max-version: ${{ steps.set-versions.outputs.rust-max-version }}
    steps:
      - uses: actions/checkout@v6

      - name: Read max Rust version from rust-toolchain.toml
        id: set-versions
        run: |
          RUST_MAX_VERSION=$(grep '^channel' rust-toolchain.toml | sed 's/.*"\(.*\)"/\1/')
          echo "RUST_MAX_VERSION=$RUST_MAX_VERSION"
          RUST_VERSIONS='["${{ env.RUST_MIN_VERSION }}", "'"$RUST_MAX_VERSION"'"]'
          echo "rust-versions=$RUST_VERSIONS" >> $GITHUB_OUTPUT
          echo "rust-max-version=$RUST_MAX_VERSION" >> $GITHUB_OUTPUT
          echo "Rust versions = $RUST_VERSIONS"

  build:
    needs: setup
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        rust-version: ${{ fromJSON(needs.setup.outputs.rust-versions) }}
    steps:
    - uses: actions/checkout@v6

    - name: Show cmake version
      run: cmake --version

    - name: Install rust stable
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ matrix.rust-version }}
        components: rustfmt, clippy
    
    - name: Remove rust toolchain file to avoid conflict
      run: rm rust-toolchain.toml

    - name: Run cargo check
      run: cargo +${{ matrix.rust-version }} check --all-targets

    - name: Run cargo fmt
      run: cargo +${{ matrix.rust-version }} fmt --all -- --check
    
    - name: Run cargo clippy
      run: cargo +${{ matrix.rust-version }} clippy -- -D warnings

    - name: run cmake
      run: > 
        cmake . -DCMAKE_BUILD_TYPE=Debug -B build
    - name: run build
      run: cmake --build build --config Debug

    # mysql bin has conflicting dlls with fabric than prevents fabric from starting
    - name: Remove conflict dll paths
      shell: powershell
      run: |
        get-command libprotobuf.dll | format-list
        Remove-Item -Recurse -Force "C:\Program Files\MySQL\MySQL Server 8.0\bin"

    - name: check sf exist
      run: Powershell.exe -File .\scripts\check_sf_installed.ps1

    # Creates a 5 node dev cluster
    - name: start sf cluster
      run: Powershell.exe -File .\onebox\windows\StartOnebox.ps1 -Auto

    - name: start connection
      run: Powershell.exe -File .\scripts\check_cluster_online.ps1

    - name: provision apps and run tests
      shell: powershell
      run: |
        # The test will add and remove app
        .\tests\echo_script_test.ps1
        .\scripts\echomain_stateful_ctl2.ps1 -Action Add
        .\scripts\echomain_ctl.ps1 -Action Add

    - name: Run cargo test
      run: cargo +${{ matrix.rust-version }} test --all -- --nocapture

  build-azl3:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        rust-version: ${{ fromJSON(needs.setup.outputs.rust-versions) }}
    container:
      image: mcr.microsoft.com/azurelinux/base/core:3.0
      options: --privileged
    steps:
      - name: tdnf install
        run: |
          tdnf update --noplugins --skipsignature -y
          tdnf install --noplugins --skipsignature -y tar unzip ca-certificates gcc glibc-devel binutils make

      - uses: actions/checkout@v6

      - name: Remove rust toolchain file to avoid conflict
        run: rm -f rust-toolchain.toml

      - name: Install rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust-version }}
          components: rustfmt, clippy

      - name: Install cmake
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: "~3.29.0" # Use version 3.29.x
      
      - name: Run cargo check
        run: cargo +${{ matrix.rust-version }} check --all-targets

      - name: Run cargo fmt
        run: cargo +${{ matrix.rust-version }} fmt --all -- --check
      
      - name: Run cargo clippy
        run: cargo +${{ matrix.rust-version }} clippy --all-targets -- -D warnings

      - name: run cmake
        run: > 
          cmake . -DCMAKE_BUILD_TYPE=Debug -B build
      - name: run build
        run: cmake --build build --config Debug

  build-devcontainer:
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        devcontainer-type: ["u22", "azl3"]
        rust-version: ${{ fromJSON(needs.setup.outputs.rust-versions) }}
    runs-on: ubuntu-latest
    steps:
      # There is only 20G of free os disk space by default.
      - name: Free OS disk space
        run: |
          sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc

      - name: Show disk space
        run: df -h

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure Docker to use /mnt directory
        run: |
          # Stop both docker service and socket to prevent auto-restart
          sudo systemctl stop docker docker.socket
          
          # Move existing Docker data to /mnt
          sudo mv /var/lib/docker /mnt/docker
          
          # Create or update Docker daemon configuration
          sudo mkdir -p /etc/docker
          echo '{"data-root": "/mnt/docker"}' | sudo tee /etc/docker/daemon.json
          
          # Start Docker service
          sudo systemctl start docker
          
          # Verify Docker is running and using the new data root
          docker info | grep "Docker Root Dir"
          df -h

      - name: Configure core dumps
        run: |
          mkdir -p /tmp/artifacts/coredumps/repo
          mkdir -p /tmp/artifacts/coredumps/onebox
          sudo chmod -R 777 /tmp/artifacts/coredumps
          ulimit -c unlimited
          echo "/tmp/artifacts/coredumps/core.%e.%p.%h.%t" | sudo tee /proc/sys/kernel/core_pattern

      - name: Run in Dev Container
        uses: devcontainers/ci@v0.3
        env:
          # This env var is used in the docker-compose.yml to set the rust version in the container
          RUST_VERSION: ${{ matrix.rust-version }}
        with:
          configFile: .devcontainer/${{ matrix.devcontainer-type }}/devcontainer.json
          runCmd: |
            # remove rust-toolchain file to avoid conflict
            rm -f rust-toolchain.toml
            # Check rust version matches the env var
            INSTALLED_VERSION=$(cargo --version | awk '{print $2}')
            EXPECTED_VERSION="${{ matrix.rust-version }}"
            echo "Installed Rust version: $INSTALLED_VERSION"
            echo "Expected Rust version: $EXPECTED_VERSION"
            if [ "$INSTALLED_VERSION" != "$EXPECTED_VERSION" ]; then
              echo "ERROR: Rust version mismatch!"
              exit 1
            fi
            cmake . -DCMAKE_BUILD_TYPE=Debug -B build
            cmake --build build --config Debug
            echo "Preparing test apps"
            bash ./scripts/prepare_test_apps.sh || { echo "Fail to prepare test apps"; exit 1; }
            echo "Running tests"
            cargo test --all -- --nocapture

      - name: Show disk space after run
        if: always()
        run: df -h

      - name: Copy known executable on failure for debugging
        if: failure()
        run: |
          mkdir -p /tmp/artifacts/executables
          sudo chown $USER:$USER target/debug/deps/samples_echomain_stateful2-*
          sudo cp target/debug/deps/samples_echomain_stateful2-* /tmp/artifacts/executables/ || { echo "Fail to copy known executable"; exit 1; }

      - name: Collect core dumps
        if: always()
        run: |
          echo "Collecting core dumps"
          sudo chmod -R 777 /tmp/artifacts
          ls -Ra /tmp/artifacts/coredumps
          if [ -d "/tmp/artifacts/coredumps" ] && [ "$(find /tmp/artifacts/coredumps -type f -print -quit)" ]; then
            tar -czf artifacts.tar.gz -C /tmp artifacts || { echo "Fail to archive core dumps"; exit 1; }
            echo "Core dumps collected"
          else
            echo "No core dumps found"
          fi

      - name: Upload core dumps artifact if exists
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: artifacts-${{ matrix.devcontainer-type }}-rust${{ matrix.rust-version }}-run${{ github.run_id }}-attempt${{ github.run_attempt }}
          path: artifacts.tar.gz
          if-no-files-found: ignore

  generate:
    needs: setup
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v6

    - name: Show cmake version
      run: cmake --version

    - name: Install rust stable
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ needs.setup.outputs.rust-max-version }}
        components: rustfmt, clippy

    - name: Verify rust-toolchain.toml matches expected version
      shell: bash
      run: |
        TOOLCHAIN_VERSION=$(grep '^channel' rust-toolchain.toml | sed 's/.*"\(.*\)"/\1/')
        EXPECTED_VERSION="${{ needs.setup.outputs.rust-max-version }}"
        echo "rust-toolchain.toml version: $TOOLCHAIN_VERSION"
        echo "Expected version: $EXPECTED_VERSION"
        if [ "$TOOLCHAIN_VERSION" != "$EXPECTED_VERSION" ]; then
          echo "ERROR: Version mismatch!"
          exit 1
        fi

    - name: cmake configure
      run: > 
        cmake . -DCMAKE_BUILD_TYPE=Debug -B build

    - name: remove generated com code
      run: cmake --build build --config Debug --target force_clean

    - name: generate rust code
      run: cmake --build build --config Debug --target generate_rust

    - name: check all generated files are checked in git
      run: git diff --exit-code

    - name: build rust code
      run: cmake --build build --config Debug

    - name: check crate packaging
      run: cargo package -p mssf-pal -p mssf-com -p mssf-core -p mssf-util --allow-dirty
